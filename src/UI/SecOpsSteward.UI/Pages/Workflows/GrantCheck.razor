@page "/workflows/grants/{WorkflowId:guid}"
@using System.Text.Json
@using SecOpsSteward.Data.Workflow
@using SecOpsSteward.UI.Pages.Workflows.Composer.Nodes
@using SecOpsSteward.UI.Pages.Workflows.Dialogs

@if (Workflow != null)
{
<MudContainer MaxWidth="MaxWidth.Large">
    <h3>Workflow Agent Grants</h3>
    <MudGrid>
		<MudItem md="12">
			<MudPaper Elevation="2" Class="@("p-0 " + (Workflow.Nodes.Any(n => n.Grant == null) ? "" : "configurationIncomplete"))">
				<MudTable T="SavedNode" Elevation="0" Items="@Workflow.Nodes" @bind-SelectedItem="@SelectedNode" Hover="true" Striped="true">
					<HeaderContent>
						<MudTh><MudTableSortLabel SortBy="new Func<SavedNode, object>(x=>x.Id)">Id</MudTableSortLabel></MudTh>
						<MudTh><MudTableSortLabel SortBy="new Func<SavedNode, object>(x=>x.NodeName)">Name</MudTableSortLabel></MudTh>
						<MudTh><MudTableSortLabel SortBy="new Func<SavedNode, object>(x=>x.Agent.Tag)">Agent</MudTableSortLabel></MudTh>
						<MudTh><MudTableSortLabel SortBy="new Func<SavedNode, object>(x=>x.Service.Name)">Service</MudTableSortLabel></MudTh>
						<MudTh>Status</MudTh>
					</HeaderContent>
					<RowTemplate>
						<MudTd DataLabel="Id">@Guid.Parse(context.Id).ShortId()</MudTd>
						<MudTd DataLabel="Name">@context.NodeName</MudTd>
						<MudTd DataLabel="Agent">@context.Agent.Tag (@context.Agent.AgentId.ShortId())</MudTd>
						<MudTd DataLabel="Service">@context.Package.Name (@context.Package.PluginId.ShortId())</MudTd>
						<MudTd DataLabel="Status">
							@if (context.Grant != null)
							{
								<MudIcon Color="Color.Success" Icon="@Icons.Material.Filled.ThumbUp" />
							}
							else
							{
								<MudIconButton Color="Color.Error" Icon="@Icons.Material.Filled.ThumbDown" 
											    OnClick="@(() => AddGrant(context))" Variant="@(context.Parameters.GrantScopeValuesPopulated ? Variant.Outlined : Variant.Text)" 
												Disabled="@(!context.Parameters.GrantScopeValuesPopulated)" />
							}
						</MudTd>
					</RowTemplate>
					<PagerContent>
						<MudTablePager PageSizeOptions="new int[]{10, 25}" />
					</PagerContent>
				</MudTable>
				<MudButton Color="Color.Primary" StartIcon="@Icons.Material.Filled.SelectAll" 
						    OnClick="@(async (a) => { await AddAllGrants(); })" Class="mr-2 my-1">Grant All</MudButton>
			</MudPaper>
		</MudItem>
    </MudGrid>
</MudContainer>
}

@code
{
	[Parameter]
	public Guid WorkflowId { get; set; }

	protected SavedNode SelectedNode { get; set; }

	protected WorkflowModel WorkflowModel { get; set; }
	protected SavedWorkflow Workflow { get; set; }

	protected override async Task OnInitializedAsync()
	{
		WorkflowModel = await DbContext.Workflows.FirstOrDefaultAsync(w => w.WorkflowId == WorkflowId);
		Workflow = WorkflowModel.SavedData;

		await Refresh();
	}

	protected async Task Refresh()
	{
		Workflow.Nodes.ForEach(n => n.PopulateDatabaseLinks(DbContext));

		if (!Workflow.Nodes.Any(n => n.Grant == null) &&
			!WorkflowModel.IsAgentSetGranted)
		{
			WorkflowModel.IsAgentSetGranted = true;
			await DbContext.SaveChangesAsync();
		}
		if (Workflow.Nodes.Any(n => n.Grant == null) &&
			WorkflowModel.IsAgentSetGranted)
		{
			WorkflowModel.IsAgentSetGranted = false;
			await DbContext.SaveChangesAsync();
		}

		StateHasChanged();
	}

	protected async Task AddGrant(SavedNode node)
	{
		var dialogParams = new DialogParameters();
        dialogParams.Add(nameof(GrantDialog.PluginId), new ChimeraPackageIdentifier(node.PackageId));
		dialogParams.Add(nameof(GrantDialog.Configuration), node.Parameters);
		var dlg = DialogService.Show<GrantDialog>("Grant Rights?", dialogParams);
		var dlgResult = await dlg.Result;

		if (dlgResult.Data != null && (bool)dlgResult.Data)
		{
			Snackbar.Add("Granting access for " + node.PackageId.ShortId(), Severity.Normal);
			await DataBoundApi.GrantAgentRightsToRun(CurrentUser.UserId.Id, WorkflowId, node.WorkflowStepId);
			await Refresh();
			Snackbar.Add("Access grant for " + node.PackageId.ShortId() + " complete", Severity.Normal);
		}
	}

	protected async Task AddAllGrants()
	{
		var dialogParams = new DialogParameters();
        dialogParams.Add(nameof(BulkGrantDialog.Workflow), Workflow);
		var dlg = DialogService.Show<BulkGrantDialog>("Grant All Rights?", dialogParams);
		var dlgResult = await dlg.Result;

		if (dlgResult.Data != null && (bool)dlgResult.Data)
		{
			Snackbar.Add("Granting access for workflow " + WorkflowModel.Name, Severity.Normal);
			await Task.WhenAll(Workflow.Nodes.Select(async (n) => await DataBoundApi.GrantAgentRightsToRun(CurrentUser.UserId.Id, WorkflowId, n.WorkflowStepId)));
			await Refresh();
			Snackbar.Add("Access grant for workflow " + WorkflowModel.Name + " complete", Severity.Normal);
		}
	}
}